<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin: 0 5px;
            transition: background 0.3s ease;
        }
        
        .nav a:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .nav a.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }
        
        .status-offline {
            background-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #6b7280;
        }
        
        .info-value {
            color: #111827;
        }
        
        .links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .empty-link {
            color: #9ca3af;
            font-style: italic;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            border-bottom: 2px solid #e5e7eb;
            padding: 0 10px;
        }
        
        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
        }
        
        .chart-bar {
            width: 100%;
            min-height: 5px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
        }
        
        .chart-bar.success {
            background: linear-gradient(to top, #22c55e, #86efac);
        }
        
        .chart-bar.error {
            background: linear-gradient(to top, #ef4444, #fca5a5);
        }
        
        .chart-label {
            font-size: 11px;
            color: #6b7280;
            margin-top: 8px;
            transform: rotate(-45deg);
            white-space: nowrap;
        }
        
        .chart-value {
            font-size: 12px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 5px;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .chart-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .chart-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        
        .chart-bar.memory {
            background: linear-gradient(to top, #3b82f6, #93c5fd);
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .leaderboard-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .leaderboard-table tr:hover {
            background-color: #f9fafb;
        }
        
        .leaderboard-rank {
            font-weight: 700;
            color: #764ba2;
            font-size: 1.2em;
        }
        
        .leaderboard-rank.gold {
            color: #fbbf24;
        }
        
        .leaderboard-rank.silver {
            color: #9ca3af;
        }
        
        .leaderboard-rank.bronze {
            color: #cd7f32;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Minecraft Server Dashboard</h1>
            <p>Server Information</p>
        </div>
        
        <div class="nav">
            <a href="/public" class="active">Public</a>
            <a href="/admin">Admin</a>
        </div>
        
        <div class="card">
            <h2>Server Status</h2>
            <div class="info-row">
                <span class="info-label">Status</span>
                <span class="info-value">
                    <span th:class="${status.online} ? 'status-indicator status-online' : 'status-indicator status-offline'"></span>
                    <span th:text="${status.online} ? 'Online' : 'Offline'">Online</span>
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Last Updated</span>
                <span class="info-value" th:text="${lastFetchTime != null ? #temporals.format(lastFetchTime, 'yyyy-MM-dd HH:mm:ss') : 'N/A'}">N/A</span>
            </div>
            <div class="info-row">
                <span class="info-label">MOTD</span>
                <span class="info-value" th:text="${status.motd}">A Private Minecraft Server</span>
            </div>
            <div class="info-row">
                <span class="info-label">Max Players</span>
                <span class="info-value" th:text="${status.maxPlayers}">20</span>
            </div>
            <div class="info-row">
                <span class="info-label">Current Players</span>
                <span class="info-value" th:text="${status.playerList}">Loading...</span>
            </div>
        </div>
        
        <div class="card">
            <h2>Resource Usage</h2>
            <div class="info-row">
                <span class="info-label">TPS (Ticks Per Second)</span>
                <span class="info-value" th:text="${status.resourceUsage.tps}">N/A</span>
            </div>
            <div class="info-row">
                <span class="info-label">Memory Used</span>
                <span class="info-value" th:text="${status.resourceUsage.memoryUsed}">N/A</span>
            </div>
            <div class="info-row">
                <span class="info-label">Memory Max</span>
                <span class="info-value" th:text="${status.resourceUsage.memoryMax}">N/A</span>
            </div>
            <div class="info-row">
                <span class="info-label">Memory Free</span>
                <span class="info-value" th:text="${status.resourceUsage.memoryFree}">N/A</span>
            </div>
            <div class="info-row">
                <span class="info-label">Memory Usage</span>
                <span class="info-value">
                    <span th:text="${#numbers.formatDecimal(status.resourceUsage.memoryUsedPercent, 1, 1)} + '%'">0.0%</span>
                </span>
            </div>
        </div>
        
        <div class="card">
            <h2>External Services</h2>
            <div class="links">
                <a th:if="${dynmapUrl != null && !dynmapUrl.isEmpty()}" 
                   th:href="${dynmapUrl}" 
                   class="btn btn-primary" 
                   target="_blank">
                    üó∫Ô∏è Dynmap
                </a>
                <span th:if="${dynmapUrl == null || dynmapUrl.isEmpty()}" class="empty-link">
                    üó∫Ô∏è Dynmap (Not configured)
                </span>
                
                <a th:if="${bluemapUrl != null && !bluemapUrl.isEmpty()}" 
                   th:href="${bluemapUrl}" 
                   class="btn btn-primary" 
                   target="_blank">
                    üåê BlueMap
                </a>
                <span th:if="${bluemapUrl == null || bluemapUrl.isEmpty()}" class="empty-link">
                    üåê BlueMap (Not configured)
                </span>
            </div>
        </div>
        
        <!-- Activity Tracker Section -->
        <div th:if="${activityTrackerEnabled}" class="card">
            <h2>üìä Activity Tracker Statistics</h2>
            <div id="activityTrackerStats">
                <div class="info-row">
                    <span class="info-label">Loading...</span>
                    <span class="info-value"></span>
                </div>
            </div>
        </div>
        
        <div th:if="${activityTrackerEnabled}" class="card">
            <h2>üèÜ Player Leaderboard</h2>
            <p style="color: #6b7280; margin-bottom: 15px;">Top 10 players by hours played</p>
            <div id="leaderboardTable">
                <div style="text-align: center; padding: 40px; color: #9ca3af;">Loading...</div>
            </div>
        </div>
        
        <div class="card">
            <h2>Data Retrieval History</h2>
            <p style="color: #6b7280; margin-bottom: 15px;">Last 10 server status retrievals</p>
            
            <div style="margin-bottom: 30px;">
                <h3 class="chart-section-title">Player Activity Over Time</h3>
                <div class="chart-container">
                    <div id="playerChart" class="chart-bars"></div>
                    <div class="chart-legend">
                        <div class="chart-legend-item">
                            <div class="chart-legend-color" style="background: linear-gradient(to top, #22c55e, #86efac);"></div>
                            <span>Online</span>
                        </div>
                        <div class="chart-legend-item">
                            <div class="chart-legend-color" style="background: linear-gradient(to top, #ef4444, #fca5a5);"></div>
                            <span>Offline</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="chart-section-title">Memory Usage Over Time</h3>
                <div class="chart-container">
                    <div id="memoryChart" class="chart-bars"></div>
                    <div class="chart-legend">
                        <div class="chart-legend-item">
                            <div class="chart-legend-color" style="background: linear-gradient(to top, #3b82f6, #93c5fd);"></div>
                            <span>Memory Usage %</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                const history = data.history;
                
                const playerChartContainer = document.getElementById('playerChart');
                const memoryChartContainer = document.getElementById('memoryChart');
                playerChartContainer.innerHTML = '';
                memoryChartContainer.innerHTML = '';
                
                if (history.length === 0) {
                    playerChartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No data yet</div>';
                    memoryChartContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No data yet</div>';
                    return;
                }
                
                // Reverse to show oldest to newest
                const reversedHistory = [...history].reverse();
                
                // Find max player count for scaling
                const maxPlayers = Math.max(...reversedHistory.map(r => r.playerCount), 1);
                
                // Render Player Activity Chart
                reversedHistory.forEach(record => {
                    const barWrapper = document.createElement('div');
                    barWrapper.className = 'chart-bar-wrapper';
                    
                    const value = document.createElement('div');
                    value.className = 'chart-value';
                    value.textContent = record.playerCount;
                    
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar ' + (record.success ? 'success' : 'error');
                    const height = (record.playerCount / maxPlayers) * 100;
                    bar.style.height = Math.max(height, 5) + '%';
                    
                    // Tooltip with player info
                    const tooltipLines = [
                        `Players: ${record.playerCount}`,
                        `Status: ${record.success ? 'Online' : 'Offline'}`,
                        `Time: ${new Date(record.timestamp).toLocaleTimeString()}`
                    ];
                    
                    bar.title = tooltipLines.join('\n');
                    
                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    const date = new Date(record.timestamp);
                    label.textContent = date.toLocaleTimeString();
                    
                    barWrapper.appendChild(value);
                    barWrapper.appendChild(bar);
                    barWrapper.appendChild(label);
                    playerChartContainer.appendChild(barWrapper);
                });
                
                // Render Memory Usage Chart
                reversedHistory.forEach(record => {
                    const barWrapper = document.createElement('div');
                    barWrapper.className = 'chart-bar-wrapper';
                    
                    const memoryPercent = record.resourceUsage ? record.resourceUsage.memoryUsedPercent : 0;
                    
                    const value = document.createElement('div');
                    value.className = 'chart-value';
                    value.textContent = memoryPercent.toFixed(1) + '%';
                    
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar memory';
                    const height = memoryPercent;
                    bar.style.height = Math.max(height, 5) + '%';
                    
                    // Tooltip with memory info
                    const tooltipLines = [
                        `Memory Usage: ${memoryPercent.toFixed(1)}%`,
                        `Time: ${new Date(record.timestamp).toLocaleTimeString()}`
                    ];
                    
                    if (record.resourceUsage) {
                        tooltipLines.push(`Used: ${record.resourceUsage.memoryUsed}`);
                        tooltipLines.push(`Max: ${record.resourceUsage.memoryMax}`);
                        tooltipLines.push(`TPS: ${record.resourceUsage.tps}`);
                    }
                    
                    bar.title = tooltipLines.join('\n');
                    
                    const label = document.createElement('div');
                    label.className = 'chart-label';
                    const date = new Date(record.timestamp);
                    label.textContent = date.toLocaleTimeString();
                    
                    barWrapper.appendChild(value);
                    barWrapper.appendChild(bar);
                    barWrapper.appendChild(label);
                    memoryChartContainer.appendChild(barWrapper);
                });
            } catch (error) {
                console.error('Failed to load history:', error);
                document.getElementById('playerChart').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load history</div>';
                document.getElementById('memoryChart').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #ef4444;">Failed to load history</div>';
            }
        }
        
        // Load Activity Tracker data
        async function loadActivityTrackerStats() {
            try {
                const response = await fetch('/api/activity-tracker/stats');
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }
                const stats = await response.json();
                
                if (stats) {
                    const container = document.getElementById('activityTrackerStats');
                    container.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">Unique Players</span>
                            <span class="info-value">${stats.uniqueLogins}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Logins</span>
                            <span class="info-value">${stats.totalLogins}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load Activity Tracker stats:', error);
                const container = document.getElementById('activityTrackerStats');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">Unable to load statistics</div>';
                }
            }
        }
        
        async function loadActivityTrackerLeaderboard() {
            try {
                const response = await fetch('/api/activity-tracker/leaderboard');
                if (!response.ok) {
                    throw new Error('Failed to fetch leaderboard');
                }
                const leaderboard = await response.json();
                
                const container = document.getElementById('leaderboardTable');
                if (!leaderboard || leaderboard.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No player data available</div>';
                    return;
                }
                
                // Create table element
                const table = document.createElement('table');
                table.className = 'leaderboard-table';
                
                // Create thead
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['Rank', 'Player', 'Hours Played', 'Total Logins'].forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                
                // Create tbody
                const tbody = document.createElement('tbody');
                
                leaderboard.forEach((entry, index) => {
                    const rank = index + 1;
                    let rankClass = 'leaderboard-rank';
                    if (rank === 1) rankClass += ' gold';
                    else if (rank === 2) rankClass += ' silver';
                    else if (rank === 3) rankClass += ' bronze';
                    
                    // Safely handle hoursPlayed with null check and default value
                    const hoursFormatted = (entry.hoursPlayed != null ? entry.hoursPlayed : 0).toFixed(1);
                    
                    // Create table row element to avoid XSS vulnerabilities
                    const tr = document.createElement('tr');
                    
                    // Rank cell
                    const rankTd = document.createElement('td');
                    const rankSpan = document.createElement('span');
                    rankSpan.className = rankClass;
                    rankSpan.textContent = rank;
                    rankTd.appendChild(rankSpan);
                    tr.appendChild(rankTd);
                    
                    // Player name cell (safely escaped)
                    const nameTd = document.createElement('td');
                    nameTd.textContent = entry.playerName || 'Unknown';
                    tr.appendChild(nameTd);
                    
                    // Hours played cell
                    const hoursTd = document.createElement('td');
                    hoursTd.textContent = `${hoursFormatted} hrs`;
                    tr.appendChild(hoursTd);
                    
                    // Total logins cell
                    const loginsTd = document.createElement('td');
                    loginsTd.textContent = entry.totalLogins || 0;
                    tr.appendChild(loginsTd);
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(thead);
                table.appendChild(tbody);
                
                container.innerHTML = '';
                container.appendChild(table);
            } catch (error) {
                console.error('Failed to load Activity Tracker leaderboard:', error);
                const container = document.getElementById('leaderboardTable');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Unable to load leaderboard</div>';
                }
            }
        }
        
        // Load history on page load
        loadHistory();
        
        // Load Activity Tracker data if enabled
        const activityTrackerEnabled = /*[[${activityTrackerEnabled}]]*/ false;
        if (activityTrackerEnabled) {
            loadActivityTrackerStats();
            loadActivityTrackerLeaderboard();
        }
        
        // Auto-refresh status
        const refreshInterval = /*[[${refreshIntervalMs}]]*/ 1800000;
        setInterval(async () => {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                loadHistory(); // Refresh history chart
                if (activityTrackerEnabled) {
                    loadActivityTrackerStats();
                    loadActivityTrackerLeaderboard();
                }
                location.reload();
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }, refreshInterval);
    </script>
</body>
</html>
